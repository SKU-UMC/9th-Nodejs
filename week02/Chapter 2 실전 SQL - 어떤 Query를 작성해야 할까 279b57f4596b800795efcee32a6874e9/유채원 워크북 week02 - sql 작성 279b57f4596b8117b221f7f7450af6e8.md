# 유채원 / 워크북 week02 - sql 작성

※ 2주차 워크북 상단에 제시된 ERD 기준으로 쿼리를 작성하였습니다.

- ERD 이미지
    
    ![image.png](%EC%9C%A0%EC%B1%84%EC%9B%90%20%EC%9B%8C%ED%81%AC%EB%B6%81%20week02%20-%20sql%20%EC%9E%91%EC%84%B1%20279b57f4596b8117b221f7f7450af6e8/image.png)
    

## 1. 내가 진행중, 진행 완료한 미션 모아서 보는 쿼리(페이징 포함)

- 미션 이미지
    
    ![image.png](%EC%9C%A0%EC%B1%84%EC%9B%90%20%EC%9B%8C%ED%81%AC%EB%B6%81%20week02%20-%20sql%20%EC%9E%91%EC%84%B1%20279b57f4596b8117b221f7f7450af6e8/image%201.png)
    

코드를 줄이기 보다는 직관적으로 보기 위해 alias는 따로 사용하지 않았습니다 

```sql
SELECT [store.name](http://store.name/), mission.mission_spec, member_mission.status, [member.name](http://member.name/)
FROM member
JOIN member_mission 
	ON [member.id](http://member.id/) = member_mission.member_id
JOIN mission 
	ON member_mission.mission_id = [mission.id](http://mission.id/)
JOIN store 
	ON mission.store_id = [store.id](http://store.id/)
WHERE member_mission.status = '진행중' AND [member.name](http://member.name/) = '코채'
limit {num} offset {pagenum-1} * {num};
```

**실제로는 member.name보다 member.id나 username으로 찾아야 함 ! (이름 중복 문제)**

- 이해를 돕기 위한 실습 img
    
    ![image.png](%EC%9C%A0%EC%B1%84%EC%9B%90%20%EC%9B%8C%ED%81%AC%EB%B6%81%20week02%20-%20sql%20%EC%9E%91%EC%84%B1%20279b57f4596b8117b221f7f7450af6e8/52bae62e-6ef7-4f10-9fb4-29ad8c7c06cf.png)
    
    ![** 팀원들 닉네임 좀 빌렸습니다 😊 **](%EC%9C%A0%EC%B1%84%EC%9B%90%20%EC%9B%8C%ED%81%AC%EB%B6%81%20week02%20-%20sql%20%EC%9E%91%EC%84%B1%20279b57f4596b8117b221f7f7450af6e8/image%202.png)
    
    ** 팀원들 닉네임 좀 빌렸습니다 😊 **
    
- 서브쿼리 ver. (but, 굳이…)
    
    ```java
    SELECT store.name, mission.mission_spec, member_mission.status, [member.name](http://mem.name/) 
    FROM member_mission
    JOIN mission ON member_mission.mission_id = mission[.id](http://m.id/)
    JOIN store s ON mission.store_id = [s.id](http://s.id/)
    JOIN member ON member_mission.member_id = member[.id](http://mem.id/)
    WHERE member_mission.status = '진행중'
    AND member_mission.member_id = (
    SELECT id FROM member WHERE name = '코채'
    );
    ```
    
- 커서 페이지 ver. (member_mission_id를 기준으로 함, 중복될 일 없기 때문에 따로 cursor_value는 생성하지 않음)
    
    ```sql
    SELECT store.name, mission.mission_spec, member_mission.status, member.name
    FROM member
    JOIN member_mission 
    	ON member.id = member_mission.member_id
    JOIN mission 
    	ON member_mission.mission_id = mission.id
    JOIN store 
    	ON mission.store_id = store.id
    WHERE 
        member_mission.status = '진행중'
        AND member.name = '코채'
    ORDER BY 
        member_mission.id DESC
    LIMIT {num};
    //첫번째 페이지
    ```
    
    ```sql
    //이후 페이지
    SELECT store.name, mission.mission_spec, member_mission.status, member.name
    FROM member
    JOIN member_mission 
    	ON member.id = member_mission.member_id
    JOIN mission 
    	ON member_mission.mission_id = mission.id
    JOIN store 
    	ON mission.store_id = store.id
    WHERE 
        member_mission.status = '진행중'
        AND member.name = '코채'
        AND member_mission.id < {cursor_id}
    ORDER BY 
        member_mission.id DESC
    LIMIT {num};
    // cursor_id는 클라이언트측에서 마지막 조회데이터에서
    // 다음 페이지 요청할 때 서버에 전달하는 값!!!!!!!!!!!!!!
    ```
    

## 2. 리뷰 작성 쿼리

- 미션 이미지
    
    ![image.png](%EC%9C%A0%EC%B1%84%EC%9B%90%20%EC%9B%8C%ED%81%AC%EB%B6%81%20week02%20-%20sql%20%EC%9E%91%EC%84%B1%20279b57f4596b8117b221f7f7450af6e8/image%203.png)
    

```java
insert into review (member_id, store_id, body, score) 
values (memberId, storeId,  ‘{리뷰내용}’, ‘{⭐⭐⭐⭐}’);
```

## 3. 홈화면 쿼리(현재 선택 된 지역에서 도전이 가능한 미션 목록, 페이징 포함)

- 미션 이미지
    
    ![image.png](%EC%9C%A0%EC%B1%84%EC%9B%90%20%EC%9B%8C%ED%81%AC%EB%B6%81%20week02%20-%20sql%20%EC%9E%91%EC%84%B1%20279b57f4596b8117b221f7f7450af6e8/image%204.png)
    

** ~~현재 사용자 위치~~가 아닌 “선택된” 지역을 기준으로 한다고 했으니, 지역이 선택되어 있다고 가정

→ 만약 사용자 위치 기반으로 하고 싶다면 member 까지 join하여 address와 region 비교 로직 수행

1. 강남동 강남대로 164 → like연산자를 이용
2. 별도의 매핑 테이블 생성
3. 실시간 위치 같은 경우 api에서 위도, 경도 받아와서 법정동코드로 찾음

미션 진행 7/10 count같은 경우 지역 구분 없이 ‘user’가 수행한 미션을 전부 count한다고 가정함

```sql
SELECT 
    store.name, 
    mission.mission_spec, 
    mission.deadline, 
    member_mission.status, 
    region.name
FROM 
    region
JOIN 
    store ON region.id = store.region_id
JOIN 
    mission ON store.id = mission.store_id
JOIN 
    member_mission ON mission.mission_id = member_mission.mission_id
WHERE 
    region.name = '안암동'
ORDER BY 
    mission.deadline DESC
limit {num} offset {pagenum-1} * {num};

====================================================

SELECT COUNT(*)
FROM member_mission
where member_id = 1 and status = "진행완료" ;
```

## 4. 마이페이지 화면 쿼리

- 미션 이미지
    
    ![image.png](%EC%9C%A0%EC%B1%84%EC%9B%90%20%EC%9B%8C%ED%81%AC%EB%B6%81%20week02%20-%20sql%20%EC%9E%91%EC%84%B1%20279b57f4596b8117b221f7f7450af6e8/image%205.png)
    

```sql
select member.name, member.email, member.phone, member.point
from member where id = 3
```

> 커서 방식 페이지네이션에 대해 보충 정리
> 

- LPAD를 쓰는 이유 ?
    
    LPAD는 **SQL 함수** 중 하나로, **문자열 왼쪽에 특정 문자로 채워서 원하는 길이만큼 만들어주는 함수**
    

      길이가 다르면 이런 문제가 발생함

      2 < 10 < 100    vs     '10' < '100' < '2'

숫자 값을 일정한 길이로 왼쪽을 ‘0’으로 채워서

이렇게 고정 길이 문자열로 만들면

문자열 정렬도 숫자 정렬 순서와 일치!!